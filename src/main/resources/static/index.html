<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>問合せ先選択</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        .search-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .accordion-header {
            background-color: #007bff;
            color: white;
            padding: 12px 15px;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .accordion-header:hover {
            background-color: #0056b3;
        }
        
        .accordion-content {
            padding: 20px;
            display: block;
        }
        
        .accordion-content.collapsed {
            display: none;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
        }
        
        .form-group input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group input[type="text"]:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        
        .region-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-item label {
            cursor: pointer;
            user-select: none;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .btn-clear {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-clear:hover {
            background-color: #545b62;
        }
        
        .btn-search {
            background-color: #007bff;
            color: white;
        }
        
        .btn-search:hover {
            background-color: #0056b3;
        }
        
        .btn-cancel {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-cancel:hover {
            background-color: #545b62;
        }
        
        .btn-confirm {
            background-color: #28a745;
            color: white;
        }
        
        .btn-confirm:hover:not(:disabled) {
            background-color: #218838;
        }
        
        .btn-confirm:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .results-section {
            margin-bottom: 20px;
        }
        
        .record-count {
            margin-bottom: 10px;
            color: #495057;
            font-weight: 500;
        }
        
        .table-container {
            overflow-x: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        thead {
            background-color: #007bff;
            color: white;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        th {
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        th:hover {
            background-color: #0056b3;
        }
        
        th.sortable::after {
            content: ' ⇅';
            opacity: 0.5;
        }
        
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        input[type="checkbox"] {
            cursor: pointer;
        }
        
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
        }
        
        .url-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .input-error {
            border-color: #dc3545 !important;
            background-color: #fff5f5;
        }
        
        .input-error:focus {
            box-shadow: 0 0 0 0.2rem rgba(220,53,69,.25) !important;
        }
        
        .field-error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
        }
        
        /* Popup Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            background-color: #007bff;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 18px;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .modal-close:hover {
            opacity: 0.8;
        }
        
        .modal-body {
            padding: 20px;
            max-height: 50vh;
            overflow-y: auto;
        }
        
        .modal-body .processing {
            text-align: center;
            padding: 20px;
            color: #007bff;
            font-size: 16px;
        }
        
        .modal-body .processing::before {
            content: '⚙';
            display: block;
            font-size: 40px;
            margin-bottom: 10px;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .modal-table th {
            background-color: #28a745;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }
        
        .modal-table td {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .modal-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .modal-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .modal-btn-primary {
            background-color: #28a745;
            color: white;
        }
        
        .modal-btn-primary:hover {
            background-color: #218838;
        }
        
        .modal-btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .modal-btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .selected-count {
            background-color: #e7f3ff;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            color: #0056b3;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="pageTitle">問合せ先選択</h1>
        
        <!-- Search Section -->
        <div class="search-section">
            <div class="accordion-header" onclick="toggleAccordion()">
                <span>検索条件</span>
                <span id="accordionIcon">▼</span>
            </div>
            <div class="accordion-content" id="accordionContent">
                <div class="form-group">
                    <label for="txtRefNm">問合せ先名称</label>
                    <input type="text" id="txtRefNm" maxlength="100" placeholder="前方一致検索">
                </div>
                
                <div class="form-group">
                    <label for="txtRefKn">問合せ先名称カナ</label>
                    <input type="text" id="txtRefKn" maxlength="200" placeholder="前方一致検索">
                </div>
                
                <div class="form-group">
                    <label for="telno">電話番号</label>
                    <input type="text" id="telno" maxlength="13" placeholder="前方一致検索">
                </div>
                
                <div class="form-group">
                    <label for="urlAheadSearch">URL</label>
                    <input type="text" id="urlAheadSearch" maxlength="256" placeholder="部分一致検索">
                </div>
                
                <div class="form-group">
                    <label>地域</label>
                    <div class="region-checkboxes" id="regionCheckboxes">
                        <!-- Region checkboxes will be loaded dynamically -->
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn-clear" onclick="clearSearch()">クリア</button>
                    <button class="btn-search" onclick="searchInquiry()">検索</button>
                </div>
            </div>
        </div>
        
        <!-- Results Section -->
        <div class="results-section">
            <div class="record-count" id="recordCount">レコード件数: 0件</div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px;">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th class="sortable" onclick="sortTable('inquiryDestinationCode')">問合せ先コード</th>
                            <th class="sortable" onclick="sortTable('inquiryDestinationName')">問合せ先名称</th>
                            <th class="sortable" onclick="sortTable('inquiryDestinationKana')">問合せ先名称カナ</th>
                            <th class="sortable" onclick="sortTable('phoneNumber')">電話番号</th>
                            <th class="sortable" onclick="sortTable('prefectureName')">都道府県</th>
                            <th class="sortable" onclick="sortTable('regionName')">地域</th>
                            <th class="sortable" onclick="sortTable('urlAddressesDisplay')">URL</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <tr>
                            <td colspan="8" class="loading">検索ボタンをクリックしてください</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn-cancel" onclick="cancelSelection()">キャンセル</button>
            <button class="btn-confirm" id="confirmBtn" onclick="confirmSelection()" disabled>決定</button>
        </div>
    </div>
    
    <!-- Confirmation Popup Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>選択確認</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="processing">処理中...</div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal()">閉じる</button>
                <button class="modal-btn modal-btn-primary" onclick="submitSelection()">送信する</button>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE_URL = 'http://localhost:8080/api/inquiry-destinations';
        let currentResults = [];
        let regions = [];
        let isBulkMode = false;
        
        // Message constants (theo đặc tả)
        const MESSAGES = {
            SE4101_00040: '該当するデータがありません。検索条件を変更してください。',
            SI4101_00063: '検索結果が80件を超えています。先頭の40件のみ表示します。続行しますか？',
            SE4102_00166: '1件のみ選択してください。'
        };
        
        // Max records constants
        const MAX_DISPLAY_RECORDS = 40;
        const CONFIRM_THRESHOLD = 80;
        
        // Initialize page (初期表示処理)
        document.addEventListener('DOMContentLoaded', async () => {
            // (1) Load Core regions from 地域M table
            // - 用途区分 = Core地域
            // - 削除フラグ = false
            // - 表示順でソート
            await loadRegions();
            
            // (2) Initialize screen according to "Screen field definition"
            initializeScreen();
            
            // Check if this is bulk selection mode
            const urlParams = new URLSearchParams(window.location.search);
            isBulkMode = urlParams.get('mode') === 'bulk';
            if (isBulkMode) {
                document.getElementById('pageTitle').textContent = '問合せ先一括選択';
            }
        });
        
        // Initialize screen to default state (画面初期化)
        function initializeScreen() {
            // Clear all text inputs
            document.getElementById('txtRefNm').value = '';
            document.getElementById('txtRefKn').value = '';
            document.getElementById('telno').value = '';
            document.getElementById('urlAheadSearch').value = '';
            
            // Reset record count
            document.getElementById('recordCount').textContent = 'レコード件数: 0件';
            
            // Reset results table
            document.getElementById('resultsBody').innerHTML = 
                '<tr><td colspan="8" class="loading">検索ボタンをクリックしてください</td></tr>';
            
            // Reset select all checkbox
            document.getElementById('selectAll').checked = false;
            
            // Disable confirm button
            document.getElementById('confirmBtn').disabled = true;
            
            // Clear any error messages
            clearAllErrors();
        }
        
        // 海外地域コード
        const OVERSEAS_REGION_CODE = '99';
        
        // Load regions (全ての有効な地域を読み込み)
        async function loadRegions() {
            try {
                const response = await fetch(`${API_BASE_URL}/regions`);
                regions = await response.json();
                
                const container = document.getElementById('regionCheckboxes');
                // 初期値：「海外」以外の全項目のチェックボックスON
                container.innerHTML = regions.map(region => {
                    const isOverseas = region.regionCode === OVERSEAS_REGION_CODE;
                    const isChecked = !isOverseas; // 海外以外はチェックON
                    return `
                    <div class="checkbox-item">
                        <input type="checkbox" 
                               id="region_${region.regionCode}" 
                               value="${region.regionCode}"
                               ${isChecked ? 'checked' : ''}
                               onchange="handleRegionChange('${region.regionCode}')">
                        <label for="region_${region.regionCode}">${region.regionName}</label>
                    </div>
                `;
                }).join('');
            } catch (error) {
                console.error('Error loading regions:', error);
                // Show error message in region checkboxes area
                const container = document.getElementById('regionCheckboxes');
                container.innerHTML = '<span class="error-message">地域データの読み込みに失敗しました</span>';
            }
        }
        
        // Handle region checkbox change - mutual exclusion logic
        // 「海外」がチェックされた場合、その他の地域のチェックを全てはずす
        // 「海外」以外がチェックされた場合、「海外」のチェックをはずす
        function handleRegionChange(regionCode) {
            const clickedCheckbox = document.getElementById(`region_${regionCode}`);
            
            if (regionCode === OVERSEAS_REGION_CODE) {
                // 海外がチェックされた場合
                if (clickedCheckbox.checked) {
                    // その他の地域のチェックを全てはずす
                    regions.forEach(region => {
                        if (region.regionCode !== OVERSEAS_REGION_CODE) {
                            const checkbox = document.getElementById(`region_${region.regionCode}`);
                            if (checkbox) {
                                checkbox.checked = false;
                            }
                        }
                    });
                }
            } else {
                // 海外以外がチェックされた場合
                if (clickedCheckbox.checked) {
                    // 海外のチェックをはずす
                    const overseasCheckbox = document.getElementById(`region_${OVERSEAS_REGION_CODE}`);
                    if (overseasCheckbox) {
                        overseasCheckbox.checked = false;
                    }
                }
            }
            
            // Update confirm button state when region selection changes
            updateConfirmButton();
        }
        
        // Toggle accordion
        function toggleAccordion() {
            const content = document.getElementById('accordionContent');
            const icon = document.getElementById('accordionIcon');
            content.classList.toggle('collapsed');
            icon.textContent = content.classList.contains('collapsed') ? '▶' : '▼';
        }
        
        // Clear search
        function clearSearch() {
            document.getElementById('txtRefNm').value = '';
            document.getElementById('txtRefKn').value = '';
            document.getElementById('telno').value = '';
            document.getElementById('urlAheadSearch').value = '';
            
            // Clear error messages
            clearAllErrors();
            
            // Reset region checkboxes - 初期値：「海外」以外の全項目のチェックボックスON
            regions.forEach(region => {
                const checkbox = document.getElementById(`region_${region.regionCode}`);
                if (checkbox) {
                    const isOverseas = region.regionCode === OVERSEAS_REGION_CODE;
                    checkbox.checked = !isOverseas; // 海外以外はチェックON
                }
            });
        }
        
        // Validation functions
        // 検索条件入力領域の入力チェック
        function validateInput() {
            clearAllErrors();
            let isValid = true;
            let firstErrorField = null;
            
            // Validate 問合せ先名称 (文字種: 全角半角, 桁数: 最大100桁)
            const txtRefNm = document.getElementById('txtRefNm');
            if (txtRefNm.value && txtRefNm.value.length > 100) {
                showFieldError(txtRefNm, '問合せ先名称は100文字以内で入力してください。');
                isValid = false;
                if (!firstErrorField) firstErrorField = txtRefNm;
            }
            
            // Validate 問合せ先名称カナ (文字種: 全角半角, 桁数: 最大200桁)
            const txtRefKn = document.getElementById('txtRefKn');
            if (txtRefKn.value && txtRefKn.value.length > 200) {
                showFieldError(txtRefKn, '問合せ先名称カナは200文字以内で入力してください。');
                isValid = false;
                if (!firstErrorField) firstErrorField = txtRefKn;
            }
            
            // Validate 電話番号 (文字種: 半角, 桁数: 最大13桁)
            const telno = document.getElementById('telno');
            if (telno.value) {
                // 半角数字とハイフンのみ許可
                if (!isValidPhoneNumber(telno.value)) {
                    showFieldError(telno, '電話番号は半角数字とハイフンのみで入力してください。');
                    isValid = false;
                    if (!firstErrorField) firstErrorField = telno;
                } else if (telno.value.length > 13) {
                    showFieldError(telno, '電話番号は13文字以内で入力してください。');
                    isValid = false;
                    if (!firstErrorField) firstErrorField = telno;
                }
            }
            
            // Validate URL (文字種: 半角, 桁数: 最大256桁)
            const urlAheadSearch = document.getElementById('urlAheadSearch');
            if (urlAheadSearch.value) {
                if (!isHalfWidth(urlAheadSearch.value)) {
                    showFieldError(urlAheadSearch, 'URLは半角で入力してください。');
                    isValid = false;
                    if (!firstErrorField) firstErrorField = urlAheadSearch;
                } else if (urlAheadSearch.value.length > 256) {
                    showFieldError(urlAheadSearch, 'URLは256文字以内で入力してください。');
                    isValid = false;
                    if (!firstErrorField) firstErrorField = urlAheadSearch;
                }
            }
            
            // Focus on first error field
            if (firstErrorField) {
                firstErrorField.focus();
            }
            
            return isValid;
        }
        
        // 半角文字チェック
        function isHalfWidth(text) {
            // 半角英数字と一般的な記号のみ許可
            const halfWidthRegex = /^[\x20-\x7E]*$/;
            return halfWidthRegex.test(text);
        }
        
        function isValidPhoneNumber(text) {
            // 半角数字とハイフンのみ許可
            const phoneRegex = /^[0-9\-]*$/;
            return phoneRegex.test(text);
        }
        
        function showFieldError(field, message) {
            field.classList.add('input-error');
            
            // Create error message element
            let errorDiv = field.parentElement.querySelector('.field-error-message');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'field-error-message';
                field.parentElement.appendChild(errorDiv);
            }
            errorDiv.textContent = message;
        }
        
        function clearAllErrors() {
            // Remove error classes
            document.querySelectorAll('.input-error').forEach(el => {
                el.classList.remove('input-error');
            });
            
            // Remove error messages
            document.querySelectorAll('.field-error-message').forEach(el => {
                el.remove();
            });
        }
        
        // Search inquiry destinations
        async function searchInquiry() {
            // Step 1: Validate input
            if (!validateInput()) {
                return;
            }
            const selectedRegions = regions
                .filter(region => document.getElementById(`region_${region.regionCode}`).checked)
                .map(region => region.regionCode);
            
            const requestData = {
                inquiryDestinationName: document.getElementById('txtRefNm').value || null,
                inquiryDestinationKana: document.getElementById('txtRefKn').value || null,
                phoneNumber: document.getElementById('telno').value || null,
                urlAddress: document.getElementById('urlAheadSearch').value || null,
                regionCodes: selectedRegions.length > 0 ? selectedRegions : null
            };
            
            try {
                const tbody = document.getElementById('resultsBody');
                tbody.innerHTML = '<tr><td colspan="8" class="loading">検索中...</td></tr>';
                
                const response = await fetch(`${API_BASE_URL}/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                // Handle backend validation errors
                if (response.status === 400) {
                    const errorData = await response.json();
                    if (errorData.errors && errorData.errors.length > 0) {
                        // Display backend validation errors
                        clearAllErrors();
                        let firstErrorField = null;
                        
                        errorData.errors.forEach(err => {
                            const fieldMapping = {
                                'inquiryDestinationName': 'txtRefNm',
                                'inquiryDestinationKana': 'txtRefKn',
                                'phoneNumber': 'telno',
                                'urlAddress': 'urlAheadSearch'
                            };
                            const fieldId = fieldMapping[err.field];
                            if (fieldId) {
                                const field = document.getElementById(fieldId);
                                if (field) {
                                    showFieldError(field, err.message);
                                    if (!firstErrorField) firstErrorField = field;
                                }
                            }
                        });
                        
                        if (firstErrorField) firstErrorField.focus();
                        tbody.innerHTML = '<tr><td colspan="8" class="loading">検索ボタンをクリックしてください</td></tr>';
                        return;
                    }
                }
                
                const data = await response.json();
                const totalCount = data.totalCount || 0;
                
                // Step 2B: Check if no results (SE4101_00040)
                if (totalCount === 0) {
                    tbody.innerHTML = `<tr><td colspan="8" class="error-message">${MESSAGES.SE4101_00040}</td></tr>`;
                    updateRecordCount(0);
                    return;
                }
                
                // Step 2C: Check if results > 80, show confirmation (SI4101_00063)
                if (totalCount > CONFIRM_THRESHOLD) {
                    const confirmContinue = confirm(MESSAGES.SI4101_00063);
                    if (!confirmContinue) {
                        tbody.innerHTML = '<tr><td colspan="8" class="loading">検索ボタンをクリックしてください</td></tr>';
                        return;
                    }
                }
                
                // Step 3: Display results (limit to first 40 records)
                currentResults = (data.inquiryDestinations || []).slice(0, MAX_DISPLAY_RECORDS);
                
                displayResults(currentResults);
                updateRecordCount(totalCount);
            } catch (error) {
                console.error('Error searching:', error);
                const tbody = document.getElementById('resultsBody');
                tbody.innerHTML = '<tr><td colspan="8" class="error-message">検索中にエラーが発生しました</td></tr>';
            }
        }
        
        // Display results
        function displayResults(results) {
            const tbody = document.getElementById('resultsBody');
            
            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">該当するデータがありません</td></tr>';
                return;
            }
            
            tbody.innerHTML = results.map(item => `
                <tr>
                    <td><input type="checkbox" class="row-checkbox" value="${item.inquiryDestinationCode}" onchange="updateConfirmButton()"></td>
                    <td>${item.inquiryDestinationCode || ''}</td>
                    <td>${item.inquiryDestinationName || ''}</td>
                    <td>${item.inquiryDestinationKana || ''}</td>
                    <td>${item.phoneNumber || ''}</td>
                    <td>${item.prefectureName || ''}</td>
                    <td>${item.regionName || ''}</td>
                    <td class="url-cell" title="${item.urlAddressesDisplay || ''}">${item.urlAddressesDisplay || ''}</td>
                </tr>
            `).join('');
        }
        
        // Update record count
        function updateRecordCount(count) {
            document.getElementById('recordCount').textContent = `レコード件数: ${count}件`;
        }
        
        // Toggle select all
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            updateConfirmButton();
        }
        
        // Update confirm button state
        function updateConfirmButton() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            document.getElementById('confirmBtn').disabled = checkedBoxes.length === 0;
            
            // Update select all checkbox
            const allCheckboxes = document.querySelectorAll('.row-checkbox');
            const selectAll = document.getElementById('selectAll');
            if (allCheckboxes.length > 0) {
                selectAll.checked = checkedBoxes.length === allCheckboxes.length;
            }
        }
        
        // Sort table
        let currentSortColumn = '';
        let sortAscending = true;
        
        function sortTable(column) {
            if (currentSortColumn === column) {
                sortAscending = !sortAscending;
            } else {
                currentSortColumn = column;
                sortAscending = true;
            }
            
            currentResults.sort((a, b) => {
                const aVal = a[column] || '';
                const bVal = b[column] || '';
                
                if (sortAscending) {
                    return aVal.localeCompare(bVal);
                } else {
                    return bVal.localeCompare(aVal);
                }
            });
            
            displayResults(currentResults);
        }
        
        // Cancel selection - đóng thanh trượt bên phải
        function cancelSelection() {
            // Gửi message để parent window đóng slider
            if (window.parent !== window) {
                // Đang mở trong iframe/slider
                window.parent.postMessage({ 
                    type: 'INQUIRY_DESTINATION_CANCEL',
                    action: 'close_slider'
                }, '*');
            } else if (window.opener) {
                // Đang mở dưới dạng popup window
                window.opener.postMessage({ 
                    type: 'INQUIRY_DESTINATION_CANCEL',
                    action: 'close_slider'
                }, '*');
                window.close();
            } else {
                // Fallback: đóng window trực tiếp
                window.close();
            }
        }
        
        // Selected items for modal
        let selectedItemsForSubmit = [];
        
        // Confirm selection - 決定ボタン処理
        function confirmSelection() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            const selectedCodes = Array.from(checkedBoxes).map(cb => cb.value);
            
            // (1) 選択された値の妥当性チェック
            // A. 問合せ先一括追加ボタンから開かれた場合、または
            //    問合せ先パターン指定画面の一括追加機能以外から開かれた場合に
            //    複数選択されていたらエラー (SE4102_00166)
            // isBulkMode = true の場合のみ複数選択可能
            if (!isBulkMode && selectedCodes.length > 1) {
                alert(MESSAGES.SE4102_00166);
                return;
            }
            
            // 選択された問合せ先の全データを取得
            selectedItemsForSubmit = currentResults.filter(item => 
                selectedCodes.includes(item.inquiryDestinationCode)
            );
            
            console.log('Selected items:', selectedItemsForSubmit);
            
            // Show modal with processing
            showModal();
            
            // Simulate processing delay then show table
            setTimeout(() => {
                displaySelectedItemsInModal(selectedItemsForSubmit);
            }, 500);
        }
        
        // Show modal
        function showModal() {
            document.getElementById('confirmModal').classList.add('active');
            document.getElementById('modalBody').innerHTML = '<div class="processing">処理中...</div>';
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('confirmModal').classList.remove('active');
        }
        
        // Display selected items in modal
        function displaySelectedItemsInModal(items) {
            const modalBody = document.getElementById('modalBody');
            
            let html = `
                <div class="selected-count">
                    選択件数: ${items.length}件
                </div>
                <table class="modal-table">
                    <thead>
                        <tr>
                            <th>問合せ先コード</th>
                            <th>問合せ先名称</th>
                            <th>問合せ先名称カナ</th>
                            <th>電話番号</th>
                            <th>都道府県</th>
                            <th>地域</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            items.forEach(item => {
                html += `
                    <tr>
                        <td>${item.inquiryDestinationCode || ''}</td>
                        <td>${item.inquiryDestinationName || ''}</td>
                        <td>${item.inquiryDestinationKana || ''}</td>
                        <td>${item.phoneNumber || ''}</td>
                        <td>${item.prefectureName || ''}</td>
                        <td>${item.regionName || ''}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            modalBody.innerHTML = html;
        }
        
        // Submit selection - 送信処理
        function submitSelection() {
            // (2) 選択した問合せ先レコードの全データを前画面に渡す
            const messageData = { 
                type: 'INQUIRY_DESTINATION_SELECTED',
                selectedItems: selectedItemsForSubmit,
                isBulkSelection: isBulkMode
            };
            
            if (window.parent !== window) {
                // iframe/slider から開かれた場合
                window.parent.postMessage(messageData, '*');
            } else if (window.opener) {
                // popup window から開かれた場合
                window.opener.postMessage(messageData, '*');
            }
            
            // Close modal
            closeModal();
            
            // Show success message
            alert(`${selectedItemsForSubmit.length}件の問合せ先を選択しました`);
            
            // (3) 右スライダーを閉じる
            if (window.parent !== window) {
                // iframe/slider の場合、親にクローズを要求
                window.parent.postMessage({ 
                    type: 'INQUIRY_DESTINATION_CLOSE_SLIDER',
                    action: 'close_slider'
                }, '*');
            } else if (window.opener) {
                // popup window の場合
                window.close();
            } else {
                // Fallback
                window.close();
            }
        }
    </script>
</body>
</html>
